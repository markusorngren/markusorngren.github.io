<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Markus Mouse & Cheese Tracker</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --app-height: 100svh;
            --primary: #4CAF50;
            --blue: #2196F3;
            --orange: #FF9800;
        }

        body { 
            font-family: 'Segoe UI', sans-serif;
            margin: 0; 
            background: #fdf6e3; 
            overflow: hidden; 
            height: var(--app-height); 
            width: 100vw; 
            position: fixed; 
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
        }

        #version-tag {
            position: fixed;
            bottom: 5px;
            right: 5px;
            font-size: 10px;
            color: rgba(0,0,0,0.3);
            z-index: 9999;
            pointer-events: none;
        }

        header {
            background: white;
            padding: 10px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-container {
            display: flex;
            gap: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        #map { 
            flex-grow: 1;
            width: 100%;
            z-index: 1;
        }

        #game-area {
            height: 180px;
            background: #fff;
            border-top: 3px solid #ddd;
            position: relative;
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .game-controls {
            padding: 10px;
            display: flex;
            gap: 10px;
            background: #eee;
        }

        .apple-grid {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            align-content: start;
            scroll-behavior: smooth;
        }

        .apple-step {
            font-size: 24px;
            text-align: center;
            opacity: 0.3;
            transition: opacity 0.3s;
            position: relative;
        }

        .apple-step.reached { opacity: 1; }
        .apple-step.target { filter: drop-shadow(0 0 5px gold); opacity: 1; }

        #the-mouse {
            position: absolute;
            font-size: 30px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
            pointer-events: none;
            margin-top: -5px;
            margin-left: -5px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            active-transform: translateY(2px);
        }

        .btn-primary { background: var(--primary); }
        .btn-blue { background: var(--blue); }
        .btn-orange { background: var(--orange); }
        .btn:disabled { background: #ccc; }

        #victory-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: var(--app-height);
            background: rgba(76, 175, 80, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            text-align: center;
        }

        .confetti {
            position: absolute;
            width: 10px; height: 10px;
            background: yellow;
            animation: fall 3s linear forwards;
        }

        @keyframes fall {
            to { transform: translateY(100vh) rotate(360deg); }
        }

        .mode-selector {
            display: flex;
            gap: 5px;
            background: #ddd;
            padding: 3px;
            border-radius: 8px;
        }

        .mode-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            background: transparent;
        }

        .mode-btn.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #target-info {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 5px 15px;
            border-radius: 20px;
            z-index: 500;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="version-tag">v1.1.2-stable</div>

    <header>
        <div class="stats-container">
            <div>游늸 <span id="dist-val">0.0</span> km</div>
            <div>游꼝 <span id="apple-count">0</span></div>
        </div>
        <div class="mode-selector">
            <button id="mode-1" class="mode-btn active" onclick="setMode(1)">Enkel</button>
            <button id="mode-2" class="mode-btn" onclick="setMode(2)">Retur</button>
        </div>
    </header>

    <div id="target-info">Klicka p친 kartan f칬r att s칛tta m친l</div>
    <div id="map"></div>

    <div id="game-area">
        <div class="game-controls">
            <button id="start-btn" class="btn btn-primary" onclick="startGame()">STARTA RESAN</button>
            <button id="share-btn" class="btn btn-blue" onclick="shareApp()">DELA</button>
            <button id="reset-btn" class="btn btn-orange" onclick="resetGame()">RESET</button>
        </div>
        <div class="apple-grid" id="apple-grid">
            <div id="the-mouse">游냜</div>
            </div>
    </div>

    <div id="victory-screen">
        <h1>MUMS! 游</h1>
        <p>Musen 칛r m칛tt och bel친ten!</p>
        <div style="font-size: 80px; margin: 20px;">游냜游</div>
        <button class="btn btn-primary" style="flex:none; width: 200px;" onclick="location.reload()">SPELA IGEN</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- TILLST칀ND & VARIABLER ---
        let map, userMarker, targetMarker, pathPolyline;
        let userCoords = null;
        let targetCoords = JSON.parse(localStorage.getItem('lastTarget')) || null;
        let gameState = 'IDLE'; // IDLE, GAME, FINISHED
        let travelMode = 1; // 1 = Enkel, 2 = Tur & Retur
        let initialDist = 0;
        let initialTotalKm = 0;
        let lastMouseIndex = 0;
        let initialZoomPerformed = false;
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- APPLIKATIONS-LOGIK ---

        function initApp() {
            // Fixa h칬jd f칬r mobiler
            const setHeight = () => document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
            window.addEventListener('resize', setHeight);
            setHeight();

            // Initiera karta
            map = L.map('map', { zoomControl: false }).setView([59.3293, 18.0686], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            // Mus-ikon (Anv칛ndarens position)
            const mouseIcon = L.divIcon({ html: '游늸', className: 'user-icon', iconSize: [30, 30] });
            userMarker = L.marker([0,0], {icon: mouseIcon}).addTo(map);

            if (targetCoords) {
                setTarget(targetCoords, false);
                map.setView(targetCoords, 14);
                initialZoomPerformed = true;
            }

            // Klick-lyssnare f칬r karta
            let touchTimer;
            map.on('mousedown', (e) => {
                touchTimer = setTimeout(() => setTarget(e.latlng), 500);
            });
            map.on('mouseup mousemove dragstart', () => clearTimeout(touchTimer));
            map.on('click', (e) => setTarget(e.latlng));

            // GPS-sp친rning
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(handlePositionUpdate, 
                    (err) => console.log("GPS Error:", err), 
                    { enableHighAccuracy: true, maximumAge: 1000 }
                );
            }

            // Service Worker f칬r PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            }
        }

        function setMode(m) {
            if (gameState !== 'IDLE') return;
            travelMode = m;
            document.querySelectorAll('.mode-btn').forEach((b, i) => {
                b.classList.toggle('active', i + 1 === m);
            });
            playClickSound();
            updatePath();
        }

        function handlePositionUpdate(pos) {
            userCoords = [pos.coords.latitude, pos.coords.longitude];
            userMarker.setLatLng(userCoords);
            
            if (!initialZoomPerformed && userCoords) {
                zoomToUser();
                initialZoomPerformed = true;
            }

            if (gameState === 'GAME') {
                updateProgress();
            } else {
                updatePath();
            }
        }

        function zoomToUser() {
            if (userCoords) map.flyTo(userCoords, 15);
        }

        async function setTarget(latlng, save = true) {
            if (gameState !== 'IDLE') return;
            if (targetMarker) map.removeLayer(targetMarker);
            
            targetCoords = latlng;
            targetMarker = L.marker(latlng, {
                icon: L.divIcon({ html: '游', className: 'cheese-icon', iconSize: [30,30] })
            }).addTo(map);

            if (save) {
                localStorage.setItem('lastTarget', JSON.stringify(latlng));
                playClickSound();
            }
            
            updatePath();
        }

        async function updatePath() {
            if (!userCoords || !targetCoords) return;
            
            try {
                const response = await fetch(`https://router.project-osrm.org/route/v1/walking/${userCoords[1]},${userCoords[0]};${targetCoords.lng},${targetCoords.lat}?overview=full&geometries=geojson`);
                const data = await response.json();
                
                if (data.routes && data.routes[0]) {
                    const route = data.routes[0];
                    initialDist = route.distance / 1000;
                    document.getElementById('dist-val').innerText = initialDist.toFixed(2);
                    
                    if (pathPolyline) map.removeLayer(pathPolyline);
                    pathPolyline = L.geoJSON(route.geometry, { color: '#4CAF50', weight: 5, opacity: 0.6 }).addTo(map);
                }
            } catch (e) {
                console.error("Route error", e);
            }
        }

        function startGame() {
            if (!userCoords || !targetCoords || initialDist < 0.01) {
                alert("V칛lj ett m친l p친 kartan f칬rst!");
                return;
            }
            
            gameState = 'GAME';
            document.getElementById('start-btn').disabled = true;
            
            // Ber칛kna total distans (Dubbla om tur-och-retur)
            initialTotalKm = travelMode === 2 ? initialDist * 2 : initialDist;
            
            // Fix f칬r att undvika oj칛mna steg vid mode 2
            if (travelMode === 2 && Math.floor(initialTotalKm) % 2 !== 0) {
                // Vi l칛gger inte till fysisk distans, men vi ser till att logiken har ett j칛mnt antal steg
            }

            const steps = Math.max(5, Math.floor(initialTotalKm * 10)); // Ett 칛pple per 100m
            const grid = document.getElementById('apple-grid');
            
            // Rensa gamla 칛pplen (beh친ll musen)
            const mouseHtml = document.getElementById('the-mouse').outerHTML;
            grid.innerHTML = mouseHtml;

            for (let i = 0; i < steps; i++) {
                const div = document.createElement('div');
                div.id = `step-${i}`;
                div.className = 'apple-step';
                div.innerHTML = (i === steps - 1) ? '游' : '游꼝';
                grid.appendChild(div);
            }

            document.getElementById('apple-count').innerText = steps;
            setTimeout(() => moveMouse(0), 100);
            playClickSound();
        }

        function updateProgress() {
            if (!userCoords || !targetCoords || gameState !== 'GAME') return;

            const currentDistToTarget = map.distance(userCoords, targetCoords) / 1000;
            let finishedSteps = 0;
            
            if (travelMode === 1) {
                const progress = Math.min(1, 1 - (currentDistToTarget / initialDist));
                finishedSteps = Math.floor(progress * initialTotalKm * 10);
            } else {
                // Tur och Retur logik
                const hasReachedTarget = currentDistToTarget < 0.05;
                if (!window.targetReached && hasReachedTarget) {
                    window.targetReached = true;
                    playVictorySound();
                }

                if (!window.targetReached) {
                    const progress = Math.min(0.5, (1 - (currentDistToTarget / initialDist)) * 0.5);
                    finishedSteps = Math.floor(progress * initialTotalKm * 10);
                } else {
                    const distHome = map.distance(userCoords, JSON.parse(localStorage.getItem('startPoint') || JSON.stringify(userCoords))) / 1000;
                    // F칬renklad retur-logik
                    const returnProgress = Math.min(1, 1 - (currentDistToTarget / initialDist)); 
                    finishedSteps = Math.floor((0.5 + (returnProgress * 0.5)) * initialTotalKm * 10);
                }
            }

            // Markera avklarade 칛pplen
            const steps = document.querySelectorAll('.apple-step');
            steps.forEach((s, i) => {
                if (i <= finishedSteps) s.classList.add('reached');
            });

            if (finishedSteps >= steps.length - 1) {
                setTimeout(finishGame, 500);
            } else {
                const safeIndex = Math.max(0, Math.min(finishedSteps, steps.length - 1));
                moveMouse(safeIndex); 
            }
        }

        function finishGame() {
            if (gameState === 'FINISHED') return;
            gameState = 'FINISHED';
            const mouse = document.getElementById('the-mouse');
            mouse.innerHTML = '游냜游'; 
            mouse.classList.add('victory');
            
            playVictorySound();
            createConfetti();
            document.getElementById('victory-screen').style.display = 'flex';
            
            const interval = setInterval(() => {
                if(gameState !== 'FINISHED') clearInterval(interval);
                else createConfetti();
            }, 1000);
        }

        function moveMouse(index) {
            if (gameState !== 'GAME') return;
            lastMouseIndex = index;
            const mouse = document.getElementById('the-mouse');
            const targetStep = document.getElementById(`step-${index}`);
            if (targetStep) {
                mouse.style.left = targetStep.offsetLeft + "px";
                mouse.style.top = targetStep.offsetTop + "px";
                
                // NYTT: Scrolla s친 att musen alltid 칛r i bild i grid-vyn
                targetStep.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function resetGame() {
            if (confirm("Vill du nollst칛lla resan?")) {
                location.reload();
            }
        }

        // --- LJUD & EFFEKTER ---

        function playClickSound() {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        function playVictorySound() {
            const notes = [523.25, 659.25, 783.99, 1046.50];
            notes.forEach((f, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(f, audioCtx.currentTime + (i * 0.15));
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime + (i * 0.15));
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + (i * 0.15) + 0.4);
                osc.start(audioCtx.currentTime + (i * 0.15));
                osc.stop(audioCtx.currentTime + (i * 0.15) + 0.4);
            });
        }

        function createConfetti() {
            for (let i = 0; i < 30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                c.style.animationDuration = (Math.random() * 2 + 1) + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3000);
            }
        }

        async function shareApp() {
            playClickSound();
            const shareData = {
                title: 'Marcus Mouse & Cheese Tracker',
                text: 'Hj칛lp musen hitta osten! Jag har ' + document.getElementById('dist-val').innerText + ' km kvar!',
                url: window.location.href
            };
            try {
                if (navigator.share) await navigator.share(shareData);
                else alert("L칛nken 칛r: " + window.location.href);
            } catch (e) {}
        }

        // Starta allt
        window.onload = initApp;
    </script>
</body>
</html>
